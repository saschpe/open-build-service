<% if @services || @package.can_edit?(session[:login])%>
  <h3>Source Services</h3>
  <p>Services allow to automatically process package sources. They are applied in descending order.</p>

  <% number = 0 %>
  <% @services.each do |service|
    number += 1 %>
    <div>
      <% object_id = "service_#{number}" %>
      <div class="service" id="<%= object_id %>" style="margin-left: 15px; ">
        <%= image_tag('icons/cog.png') %> <b><%= h Service.summary(service.name) %></b>
        <div style="color: #999; font-size: 8pt; margin-left: 2em;">
          <%= link_text = "Show Parameters"
          link_text = image_tag('icons/cog_edit.png') + " Edit Parameters" if @package.can_edit?( session[:login] )
          link_to_remote( link_text, :url => { :action => :service_parameter, :project => @project, :package => @package, :servicename => service.name, :serviceid => number } ) %>
          <% if @package.can_edit?( session[:login] ) %>
             | <%= image_tag('icons/cog_delete.png') %>
             <%= link_to( "Remove this service", {:action => :remove_service, :project => @project, :package => @package, :id => number}, :confirm => "Remove this service (#{service.name}) ?") %>
          <% end %>
        </div>
      </div>
      <%= draggable_element(object_id) %>
      <%= drop_receiving_element( object_id,
        :hoverclass => "hover",
        :onDrop => "function(drag, drop) { window.location='/package/add_or_move_service?id=' + drop.draggable.first()[0].id + '&position=#{number}&package=#{@package}&project=#{@project}' }"
      )%>
    </div>
  <% end %>

  <% if @serviceerror %>
    <div id="error" class="error">
      <h4>Source processing is currently broken:</h4>
      <pre id="code" class="text"><%=h @serviceerror %></pre>
    </div>
  <% end %>
<% end %>

<% if @package.can_edit?(session[:login]) %>
  <p>
    <%= link_to_remote(image_tag('icons/cog_add.png'), :action => :add_service, :project => @project, :package => @package) %>
    <%= link_to_remote('Add service for source processing', :action => :add_service, :project => @project, :package => @package) %>

    <% unless @service.blank? %>
      <%= link_to(image_tag('icons/cog_go.png'), :action => :execute_services, :project => @project, :package => @package, :confirm => "Execute all services now?", :method => :post) %>
      <%= link_to('Run services now', :action => :execute_services, :project => @project, :package => @package, :confirm => "Execute all services now?", :method => :post) %>
    <% end %>
  </p>
<% end %>
